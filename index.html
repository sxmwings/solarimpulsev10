<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>üèÜ HYBRID MASTER 51 ‚Äî Ultimate V6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0b0f17;
  --card:#0f1620;
  --card-2:#151a25;
  --accent:#F59E0B;
  --accent-2:#ff8a00;
  --muted:#8b92a8;
  --success:#10b981;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
  --neon: rgba(245,158,11,0.18);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#06070a 0%, #0b0f17 100%);color:#fff;font-family:Inter, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;}
.container{max-width:1100px;margin:18px auto;padding:18px;}
.header{display:flex;align-items:center;gap:14px}
.logo{font-size:40px}
.title{font-size:22px;font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;color:transparent}
.row{display:flex;gap:12px;align-items:center}
.card{background:var(--card);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.left{flex:1}
.right{width:360px}
.programs{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:18px}
.session-list{display:flex;flex-direction:column;gap:12px}
.session-btn{background:linear-gradient(135deg,var(--accent),var(--accent-2));border:none;padding:16px;border-radius:12px;color:#071021;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(245,158,11,0.12);text-align:left}
.small{font-size:13px;color:var(--muted)}
.dashboard-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.btn{background:var(--card-2);border:1px solid rgba(255,255,255,0.03);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071021;font-weight:700;border:none}
.week-card{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
.exercise-list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
.exercise-card{border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,var(--card),var(--card-2))}
.exercise-header{display:flex;justify-content:space-between;align-items:center;padding:14px;cursor:pointer}
.exercise-name{font-weight:800;color:var(--accent)}
.exercise-meta{color:var(--muted);font-size:13px}
.exercise-details{max-height:0;overflow:hidden;transition:max-height .35s;padding:0 14px;background:rgba(255,255,255,0.01)}
.exercise-details.open{max-height:1200px;padding:14px}
.set-row{display:grid;grid-template-columns:50px 1fr 1fr 44px;gap:6px;padding:6px;background:var(--glass);border-radius:10px;align-items:center;margin-bottom:6px}
.set-input{background:transparent;border:2px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:#fff;font-weight:700;text-align:center;font-size:13px}
.set-checkbox{display:none}
.set-checkbox+label{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--card-2);font-size:12px}
.set-checkbox:checked+label{background:var(--success);border-color:var(--success);transform:scale(1.08)}
.technique-banner{background:linear-gradient(135deg,var(--neon), rgba(251,191,36,0.08));border:1px solid rgba(245,158,11,0.2);padding:10px;border-radius:10px;color:var(--accent);font-weight:700;margin-bottom:12px;text-align:center}

.rest-timer{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--card);padding:14px;border-radius:18px;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;gap:12px;z-index:999;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.timer-circle{width:72px;height:72px;position:relative}
.timer-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)}
.timer-skip{background:transparent;border:2px solid rgba(239,68,68,0.25);color:var(--danger);width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:1200}
.modal.active{display:flex}
.modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.modal .content{position:relative;background:var(--card);padding:18px;border-radius:12px;max-width:940px;width:100%;border:1px solid rgba(255,255,255,0.04);max-height:80vh;overflow:auto;-webkit-overflow-scrolling: touch;}
.close-x{position:absolute;right:12px;top:12px;cursor:pointer;color:var(--accent)}

.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.chart-container{background:var(--card-2);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.heatmap-canvas{width:100%;height:300px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:8px}

.footer{margin-top:30px;color:var(--muted);font-size:13px;text-align:center}

.heatmap{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.heat-cell{background:rgba(255,255,255,0.02);height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
.heat-cell.c1{background:rgba(255,120,0,0.06)}
.heat-cell.c2{background:rgba(255,120,0,0.12)}
.heat-cell.c3{background:rgba(255,120,0,0.22)}
.heat-cell.c4{background:rgba(255,120,0,0.34)}
.heat-legend{display:flex;gap:6px;align-items:center;margin-top:8px}
.legend-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:12px}

.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:700px){.stats-grid{grid-template-columns:1fr}}

@media (max-width:430px){
  .container{padding:12px;margin:12px auto}
  .programs{grid-template-columns:1fr; gap:12px}
  .right{width:100%}
  .set-row{grid-template-columns:45px 1fr 1fr 40px; gap:4px; padding:4px}
  .set-input{padding:4px; font-size:12px}
  .set-checkbox+label{width:32px;height:32px;font-size:11px}
  .exercise-header{padding:12px}
  .exercise-details.open{padding:12px}
  .session-btn{padding:14px}
  .btn{padding:8px 10px; font-size:13px}
  .dashboard-actions{gap:6px}
}

@media (max-width:980px){
  .programs{grid-template-columns:1fr; }
  .right{width:100%}
  .charts{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
}

.muscle-tag{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}

.exercise-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn.ios{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:12px;padding:12px 16px;font-weight:600}
.btn.ios.primary{background:linear-gradient(135deg,#007AFF,#5856D6);color:white;border:none}
.btn.ios.danger{background:linear-gradient(135deg,#FF3B30,#FF2D55);color:white;border:none}
.session-btn.ios{background:linear-gradient(135deg,#34C759,#32D74B);color:white;font-weight:700;border:none;box-shadow:0 4px 20px rgba(52,199,89,0.3)}

@supports(padding:max(0px)){
  .container{
    padding-left:max(12px,env(safe-area-inset-left));
    padding-right:max(12px,env(safe-area-inset-right));
    padding-bottom:max(12px,env(safe-area-inset-bottom));
  }
}

/* Correction iPhone 15 Pro Max : affichage complet des cases s√©rie */
@supports (-webkit-touch-callout: none) {
  .exercise-details {
    overflow-y: visible !important;
  }
  .set-row {
    overflow: visible !important;
  }
  input.set-checkbox + label {
    min-width: 40px;
    min-height: 40px;
  }
}

/* Styles pour les supersets */
.superset-group {
  background: rgba(245, 158, 11, 0.05);
  border: 1px solid rgba(245, 158, 11, 0.1);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
}

.superset-header {
  color: var(--accent);
  font-weight: 700;
  font-size: 12px;
  margin-bottom: 8px;
  text-align: center;
}

/* ============================
   HEATMAP PREMIUM ‚Äî Weekly load & muscle breakdown
   ============================ */

.heatmap-wrap {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  border-radius: 14px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 8px 28px rgba(0,0,0,0.6);
}

.heatmap-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.heatmap-title {
  font-weight: 800;
  color: var(--accent);
}

.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-top: 12px;
}

.heat-cell {
  border-radius: 10px;
  text-align: center;
  padding: 10px;
  min-height: 64px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
}

.heat-cell:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 18px rgba(0,0,0,0.6);
}

.heat-badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 6px;
  background: rgba(255,255,255,0.08);
  position: absolute;
  bottom: 6px;
  right: 6px;
}

.heat-legend {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 14px;
  flex-wrap: wrap;
}

.legend-pill {
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  padding: 6px 10px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.legend-color {
  width: 14px;
  height: 14px;
  border-radius: 4px;
}
</style>
</head>
<body>
<div class="container">
  <div class="header row">
    <div class="logo">üèÜ</div>
    <div>
      <div class="title">HYBRID MASTER 51 ‚Äî Ultimate V6</div>
      <div class="small">26 semaines ¬∑ 3 s√©ances / semaine ¬∑ Analyse & Heatmap</div>
    </div>
    <button class="btn ios" onclick="openDayExerciseManager()">üß© G√©rer les exercices</button>
  </div>

  <div class="programs">
    <div class="left">
      <div class="week-card card row">
        <div>
          <div style="font-weight:800">Semaine <span id="weekDisplay">1</span></div>
          <div class="small" id="blockName">Bloc</div>
        </div>
        <div class="row">
          <button id="prevWeek" class="btn ios">‚Üê Pr√©c.</button>
          <button id="nextWeek" class="btn ios primary">Suiv. ‚Üí</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:800">S√©ances disponibles</div>
          <div class="small">Tap pour ouvrir</div>
        </div>
        <div class="session-list" id="progList" style="margin-top:12px"></div>
      </div>

      <div class="exercise-list" id="exerciseArea" style="margin-top:14px"></div>
    </div>

    <div class="right">
      <div class="card">
        <div style="font-weight:800">Tableau de bord</div>
        <div class="small" id="quickMsg" style="margin-top:8px">Pr√™t.</div>
        <div class="dashboard-actions" style="margin-top:12px;">
          <button id="openStats" class="btn ios">üìä Statistiques</button>
          <button id="openVolume" class="btn ios">üìà Volume</button>
          <button id="openMuscle" class="btn ios">üí™ Muscles</button>
          <button id="exportCSV" class="btn ios">üíæ Export</button>
          <button id="backupBtn" class="btn ios">‚òÅÔ∏è Backup</button>
          <button id="resetApp" class="btn ios" style="color:var(--danger)">‚ö†Ô∏è Reset</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:800;margin-bottom:8px">Heatmap de charge (semaine)</div>
        <div id="heatmapContainer">
          <div id="heatmap" class="heatmap" aria-hidden="false"></div>
          <div class="heat-legend">
            <div class="legend-pill c1" style="background:rgba(255,120,0,0.06)">Faible</div>
            <div class="legend-pill c2" style="background:rgba(255,120,0,0.12)">Moyen</div>
            <div class="legend-pill c3" style="background:rgba(255,120,0,0.22)">Haut</div>
            <div class="legend-pill c4" style="background:rgba(255,120,0,0.34)">Max</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:800">Gestion des Exercices</div>
        <div class="small" style="margin-top:8px" id="customCount">0 personnalis√©s</div>
        <div style="margin-top:8px">
          <button id="addCustom" class="btn ios">‚ûï Ajouter exercice</button>
          <button id="viewCustom" class="btn ios">üëÅ Voir</button>
          <button id="manageSessionExercises" class="btn ios">üìÖ G√©rer s√©ances</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Heatmap Premium -->
  <div class="heatmap-wrap card" style="margin-top:16px;">
    <div class="heatmap-header">
      <div class="heatmap-title">Heatmap de charge (semaine)</div>
      <div style="display:flex;align-items:center;gap:8px;">
        <button id="heatPrev" class="btn ios">‚Üê</button>
        <div id="heatWeekLabel" style="font-weight:700;">Semaine</div>
        <button id="heatNext" class="btn ios">‚Üí</button>
      </div>
    </div>

    <div id="heatmapGrid" class="heatmap-grid"></div>

    <div class="heat-legend">
      <div class="legend-pill"><div class="legend-color" style="background:#20232A;"></div>Repos</div>
      <div class="legend-pill"><div class="legend-color" style="background:#FFECB3;"></div>Faible</div>
      <div class="legend-pill"><div class="legend-color" style="background:#FFB74D;"></div>Moyen</div>
      <div class="legend-pill"><div class="legend-color" style="background:#FF8A00;"></div>Haut</div>
      <div class="legend-pill"><div class="legend-color" style="background:#F59E0B;"></div>Max</div>
    </div>
  </div>

  <div class="footer">¬© 2025 ‚Äî HYBRID MASTER 51 ‚Äî Ultimate V6</div>
</div>

<div id="restTimer" class="rest-timer" style="display:none">
  <div class="timer-circle">
    <svg width="72" height="72" viewBox="0 0 80 80">
      <circle cx="40" cy="40" r="34" stroke="rgba(255,255,255,0.06)" stroke-width="6" fill="none"/>
      <circle id="timerProgress" cx="40" cy="40" r="34" stroke="url(#g1)" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:214;stroke-dashoffset:214;transform:rotate(-90deg);transform-origin:50% 50%"></circle>
      <defs><linearGradient id="g1"><stop offset="0" stop-color="#F59E0B"/><stop offset="1" stop-color="#ff8a00"/></linearGradient></defs>
    </svg>
    <div class="timer-text" id="timerText">0:00</div>
  </div>
  <div>
    <div style="font-weight:800" id="nextExerciseName">Repos</div>
    <div class="small">Temps restant</div>
  </div>
  <button id="skipTimer" class="timer-skip">‚úï</button>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="overlay" id="modalOverlay"></div>
  <div class="content" id="modalContent">
    <div class="close-x" id="modalClose">‚úñ</div>
    <div id="modalInner"></div>
  </div>
</div>

<script>
const MUSCLE_MAPPING = {
  "Trap Bar Deadlift": { primary:["Ischios","Fessiers","Dos"], secondary:["Quadriceps","Abdominaux"], tertiary:["Mollets","Avant-bras"] },
  "Goblet Squat": { primary:["Quadriceps","Fessiers"], secondary:["Ischios","Abdominaux"], tertiary:["Mollets"] },
  "Leg Press": { primary:["Quadriceps","Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Lat Pulldown": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Landmine Press": { primary:["√âpaules","Triceps"], secondary:["Pectoraux"], tertiary:[] },
  "Rowing Machine": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Spider Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Incline Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Cable Pushdown": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Dumbbell Press": { primary:["Pectoraux"], secondary:["Triceps","√âpaules"], tertiary:[] },
  "Cable Fly": { primary:["Pectoraux"], secondary:[], tertiary:[] },
  "Leg Press l√©ger": { primary:["Quadriceps"], secondary:["Ischios","Fessiers"], tertiary:["Mollets"] },
  "Extension Triceps Corde": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Lateral Raises": { primary:["√âpaules lat√©rales"], secondary:["Trap√®zes"], tertiary:[] },
  "Face Pull": { primary:["√âpaules post√©rieures","Trap√®zes"], secondary:["Dos"], tertiary:[] },
  "Overhead Extension": { primary:["Triceps longs"], secondary:[], tertiary:[] },
  "Landmine Row": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Leg Curl": { primary:["Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Leg Extension": { primary:["Quadriceps"], secondary:[], tertiary:[] },
  "Dumbbell Fly": { primary:["Pectoraux"], secondary:["√âpaules"], tertiary:[] },
  "EZ Bar Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Wrist Curl": { primary:["Avant-bras"], secondary:[], tertiary:[] },
  "Hammer Curl": { primary:["Biceps","Avant-bras"], secondary:[], tertiary:[] }
};

const PROGRAM = {
  dimanche: {
    key:'dimanche', 
    title: "Dimanche - Dos + Jambes Lourdes + Bras (68 min)",
    exercises:[
      { name:"Trap Bar Deadlift", sets:5, reps:"6-8", rest:120, weight:75, type:"barre", tech:"RPE 6-8" },
      { name:"Goblet Squat", sets:4, reps:"10", rest:75, weight:25, type:"halt√®res", tech:"Tempo 3-1-2" },
      { name:"Leg Press", sets:4, reps:"10", rest:75, weight:110, type:"machine", tech:"Drop-set derni√®re s√©rie" },
      { name:"Lat Pulldown", sets:4, reps:"10", rest:90, weight:60, type:"machine", tech:"Myo-reps" },
      { name:"Landmine Press", sets:4, reps:"10", rest:90, weight:35, type:"barre", tech:"Tempo 2-1-2" },
      { name:"Rowing Machine", sets:4, reps:"10", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2" },
      { name:"Spider Curl / Incline Curl*", sets:4, reps:"12", rest:75, weight:12, type:"halt√®res", tech:"Rest-pause" },
      { name:"Cable Pushdown", sets:3, reps:"12", rest:75, weight:20, type:"machine", tech:"Rest-pause" }
    ]
  },
  mardi: {
    key:'mardi', 
    title:"Mardi - Pecs + √âpaules + Triceps (70 min)",
    exercises:[
      { name:"Dumbbell Press", sets:5, reps:"10", rest:105, weight:22, type:"halt√®res", tech:"Cluster sets" },
      { name:"Cable Fly", sets:4, reps:"12", rest:60, weight:10, type:"machine", tech:"Tension continue" },
      { name:"Leg Press l√©ger", sets:3, reps:"15", rest:60, weight:80, type:"machine", tech:"Standard" },
      { name:"Extension Triceps Corde", sets:5, reps:"12", rest:75, weight:20, type:"machine", tech:"Drop-set" },
      { name:"Lateral Raises", sets:5, reps:"15", rest:75, weight:8, type:"halt√®res", tech:"Myo-reps" },
      { name:"Face Pull", sets:5, reps:"15", rest:60, weight:20, type:"machine", tech:"Tempo 3-1-2" },
      { name:"Rowing Machine", sets:4, reps:"12", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2" },
      { name:"Overhead Extension", sets:4, reps:"12", rest:60, weight:15, type:"machine", tech:"Rest-pause" }
    ]
  },
  vendredi: {
    key:'vendredi', 
    title:"Vendredi - Dos + Jambes + Bras + √âpaules (73 min)",
    exercises:[
      { name:"Landmine Row", sets:5, reps:"10", rest:105, weight:55, type:"barre", tech:"Tempo 2-1-2" },
      { name:"Leg Curl", sets:5, reps:"12", rest:75, weight:40, type:"machine", tech:"Drop-set derni√®re s√©rie" },
      { name:"Leg Extension", sets:4, reps:"15", rest:75, weight:35, type:"machine", tech:"Standard" },
      { name:"Cable Fly", sets:4, reps:"15", rest:60, weight:10, type:"machine", tech:"Tension continue" },
      { name:"Dumbbell Fly", sets:4, reps:"12", rest:75, weight:10, type:"halt√®res", tech:"Tempo 3-1-2" },
      { name:"EZ Bar Curl", sets:5, reps:"12", rest:75, weight:25, type:"barre", tech:"Rest-pause" },
      { name:"Overhead Extension", sets:3, reps:"12", rest:75, weight:15, type:"machine", tech:"Rest-pause" },
      { name:"Lateral Raises", sets:3, reps:"15", rest:60, weight:8, type:"halt√®res", tech:"Myo-reps" },
      { name:"Wrist Curl", sets:3, reps:"20", rest:45, weight:30, type:"barre", tech:"Standard" }
    ]
  }
};

/* ============================
   FONCTIONS EXISTANTES
   ============================ */
function openDayExerciseManager() {
  const dayKeys = Object.keys(state.program);
  let html = `<h3 style="font-weight:800;color:var(--accent)">‚öôÔ∏è G√©rer les exercices par jour</h3>`;
  dayKeys.forEach(k => {
    const s = state.program[k];
    html += `<div style="padding:10px;background:var(--card-2);border-radius:10px;margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>${s.title}</strong><div class="small">${s.exercises.length} ex.</div></div>
        <div class="exercise-actions">
          <button class="btn ios" onclick="openAddExerciseModal('${k}')">‚ûï Ajouter</button>
          <button class="btn ios danger" onclick="removeSession('${k}')">üóëÔ∏è Vider</button>
        </div>
      </div>
    </div>`;
  });
  html += `<div style="margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`;
  openModal(html);
}

const STATE_KEY = 'hm51_v_full_v6';
let state = null;
let currentSessionKey = null;
let timer = { interval:null, remaining:0, total:0 };
let charts = { volume: null, muscle: null };
let quickTimer;

function defaultState(){
  const weights = {};
  Object.values(PROGRAM).forEach(s => s.exercises.forEach(e => { weights[e.name]=e.weight; }));
  return {
    week:1,
    program: JSON.parse(JSON.stringify(PROGRAM)),
    weights: weights,
    hist:{},
    customExercises: []
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){ console.error("loadState err",e) }
  return defaultState();
}

function saveState(){
  try{ 
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }catch(e){ console.error("saveState err",e) }
}

function showQuick(msg, color){
  const el = document.getElementById('quickMsg');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color || '';
  clearTimeout(quickTimer);
  quickTimer = setTimeout(()=>{ el.textContent='Pr√™t.'; el.style.color=''; }, 2800);
}

function renderHeader(){
  document.getElementById('weekDisplay').textContent = state.week;
  const blockName = document.getElementById('blockName');
  if(state.week<=5) blockName.textContent = 'Bloc 1 - Fondation ‚Ä¢ Tempo contr√¥l√©';
  else if(state.week<=11) blockName.textContent = 'Bloc 2 - Surcharge ‚Ä¢ Rest-Pause';
  else if(state.week<=17) blockName.textContent = 'Bloc 3 - Surcompensation ‚Ä¢ Drop-sets + Myo-reps';
  else blockName.textContent = 'Bloc 4 - Intensification ‚Ä¢ Clusters + Partials';
}

function renderProgramList(){
  const list = document.getElementById('progList');
  list.innerHTML = '';
  Object.values(state.program).forEach(s=>{
    const totalSets = s.exercises.reduce((a,b)=>a+b.sets,0);
    const btn = document.createElement('button');
    btn.className='session-btn ios';
    btn.innerHTML = `<div style="font-weight:800">${s.title}</div><div class="small">${s.exercises.length} ex ‚Ä¢ ${totalSets} s√©ries</div>`;
    btn.onclick = ()=> openSession(s.key);
    list.appendChild(btn);
  });
  document.getElementById('customCount').textContent = `${state.customExercises.length} personnalis√©s`;
}

function openSession(key){
  currentSessionKey = key;
  const arr = state.program[key].exercises;
  const area = document.getElementById('exerciseArea');
  area.innerHTML = '';
  
  const sessionHeader = document.createElement('div');
  sessionHeader.className = 'card';
  sessionHeader.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800">${state.program[key].title}</div>
      <div class="exercise-actions">
        <button class="btn ios" onclick="openAddExerciseModal('${key}')">‚ûï Ajouter</button>
        <button class="btn ios danger" onclick="removeSession('${key}')">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `;
  area.appendChild(sessionHeader);
  
  arr.forEach((ex, index)=>{
    const exId = sanitizeId(ex.name);
    const card = document.createElement('div'); card.className='exercise-card';
    const header = document.createElement('div'); header.className='exercise-header';
    header.innerHTML = `<div style="flex:1"><div class="exercise-name">${ex.name}</div>
      <div class="exercise-meta">${ex.sets}√ó ${ex.reps} ‚Ä¢ ${ex.rest}s repos ‚Ä¢ ${ (state.weights[ex.name]||ex.weight) }kg</div></div>
      <div class="exercise-arrow" id="arrow-${exId}">‚ñº</div>`;
    header.addEventListener('click', ()=> toggleDetails(ex));
    const details = document.createElement('div'); details.className='exercise-details'; details.id='details-'+exId;
    card.appendChild(header); card.appendChild(details);
    area.appendChild(card);
  });
  window.scrollTo({top:0,behavior:'smooth'});
  showQuick('S√©ance ouverte');
}

function toggleDetails(ex){
  const exId = sanitizeId(ex.name);
  const details = document.getElementById('details-'+exId);
  const arrow = document.getElementById('arrow-'+exId);
  if(!details) return;
  const isOpen = details.classList.contains('open');
  document.querySelectorAll('.exercise-details.open').forEach(d=>{
    if(d!==details) { d.classList.remove('open'); d.innerHTML=''; const aid = d.id.replace('details-',''); const ar = document.getElementById('arrow-'+aid); if(ar) ar.classList.remove('open'); }
  });
  if(isOpen){ details.classList.remove('open'); details.innerHTML=''; if(arrow) arrow.classList.remove('open'); return; }
  renderExerciseDetails(ex);
  details.classList.add('open');
  if(arrow) arrow.classList.add('open');
}

function renderExerciseDetails(ex){
  const exId = sanitizeId(ex.name);
  const details = document.getElementById('details-'+exId);
  if(!details) return;
  const w = state.weights[ex.name] || ex.weight;
  const last = (state.hist[ex.name] && state.hist[ex.name].length) ? state.hist[ex.name][state.hist[ex.name].length-1] : null;
  let perfHtml = '';
  if(last) perfHtml = `<div style="background:rgba(16,185,129,0.08);padding:10px;border-radius:8px;border:1px solid rgba(16,185,129,0.12);margin-bottom:10px">Derni√®re: ${last.weight}kg √ó ${last.reps} reps (Semaine ${last.week})</div>`;
  else perfHtml = `<div style="background:${'rgba(245,158,11,0.06)'};padding:10px;border-radius:8px;border:1px solid rgba(245,158,11,0.08);margin-bottom:10px">Premi√®re fois pour cet exercice</div>`;

  const mm = MUSCLE_MAPPING[ex.name] || {primary:[],secondary:[],tertiary:[]};
  let muscleHtml = '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">';
  mm.primary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(245,158,11,0.22);color:var(--accent)">${m}</span>`);
  mm.secondary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(59,130,246,0.12);color:#60a5fa">${m}</span>`);
  mm.tertiary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(139,92,246,0.08);color:#b794f4">${m}</span>`);
  muscleHtml += '</div>';

  let setsHtml = '';
  for(let i=1;i<=ex.sets;i++){
    setsHtml += `<div class="set-row">
      <div class="set-label" style="font-size:12px;color:var(--muted)">S√©rie ${i}</div>
      <div><input class="set-input w-${exId}-${i}" type="number" step="0.5" value="${w}" placeholder="KG"></div>
      <div><input class="set-input r-${exId}-${i}" type="number" value="${(typeof ex.reps==='number')?ex.reps:parseInt(String(ex.reps).split('-')[0])}" placeholder="REPS"></div>
      <div><input id="s-${i}-${exId}" class="set-checkbox" type="checkbox"><label for="s-${i}-${exId}">‚úì</label></div>
    </div>`;
  }

  details.innerHTML = `<div class="technique-banner">‚ú® ${ex.tech}${getTechniqueByWeek()}</div>
    ${perfHtml}
    ${muscleHtml}
    ${setsHtml}
    <div class="exercise-actions">
      <button class="btn ios" onclick="openModifyWeight('${encodeURIComponent(ex.name)}')">‚úèÔ∏è Poids</button>
      <button class="btn ios primary" onclick="savePerf('${encodeURIComponent(ex.name)}')">üíæ Enregistrer</button>
      <button class="btn ios danger" onclick="removeExerciseFromSession('${encodeURIComponent(ex.name)}')">üóëÔ∏è Retirer</button>
    </div>`;

  const checkboxes = details.querySelectorAll('.set-checkbox');
  checkboxes.forEach((cb, idx)=>{
    cb.addEventListener('change', function(){
      if(this.checked){
        if(navigator.vibrate) navigator.vibrate(50);
        const isLast = idx === checkboxes.length - 1;
        const nextText = isLast ? 'Prochain exercice' : 'Repos';
        startRestCountdown(ex.rest, nextText);
      }
    });
  });
}

function getTechniqueByWeek() {
  if(state.week <= 5) return ' ‚Ä¢ Tempo 3-1-2 (Bloc 1)';
  else if(state.week <= 11) return ' ‚Ä¢ Rest-Pause (Bloc 2)';
  else if(state.week <= 17) return ' ‚Ä¢ Drop-sets + Myo-reps (Bloc 3)';
  else return ' ‚Ä¢ Clusters + Partials (Bloc 4)';
}

function openAddExerciseModal(sessionKey) {
  const session = state.program[sessionKey];
  openModal(`<h3 style="font-weight:800;color:var(--accent)">Ajouter √† ${session.title}</h3>
    <div style="display:grid;gap:8px">
      <input id="globalExName" class="set-input" placeholder="Nom de l'exercice" />
      <select id="globalExType" class="set-input">
        <option>halt√®res</option>
        <option>barre</option>
        <option>machine</option>
        <option>poids du corps</option>
      </select>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="globalExSets" class="set-input" type="number" value="3" placeholder="S√©ries"/>
        <input id="globalExReps" class="set-input" value="10" placeholder="Reps"/>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <input id="globalExRest" class="set-input" type="number" value="90" placeholder="Repos (s)"/>
        <input id="globalExWeight" class="set-input" type="number" value="20" placeholder="Poids (kg)"/>
      </div>
      <input id="globalExTech" class="set-input" value="Standard" placeholder="Technique"/>
      <div class="exercise-actions">
        <button class="btn ios primary" onclick="saveGlobalExercise('${sessionKey}')">Ajouter</button>
        <button class="btn ios" onclick="closeModal()">Annuler</button>
      </div>
    </div>`);
}

function saveGlobalExercise(sessionKey) {
  const name = document.getElementById('globalExName').value.trim();
  if(!name){ alert('Nom requis'); return; }
  const newEx = {
    name: name,
    type: document.getElementById('globalExType').value,
    sets: parseInt(document.getElementById('globalExSets').value)||3,
    reps: document.getElementById('globalExReps').value,
    rest: parseInt(document.getElementById('globalExRest').value)||90,
    weight: parseFloat(document.getElementById('globalExWeight').value)||0,
    tech: document.getElementById('globalExTech').value||'Standard'
  };
  
  state.program[sessionKey].exercises.push(newEx);
  state.weights[newEx.name] = newEx.weight;
  saveState();
  closeModal();
  showQuick('Exercice ajout√© ‚úì','#10b981');
}

function removeExerciseFromSession(encodedName){
  const name = decodeURIComponent(encodedName);
  if(!currentSessionKey || !confirm(`Retirer "${name}" de cette s√©ance ?`)) return;
  
  state.program[currentSessionKey].exercises = state.program[currentSessionKey].exercises.filter(ex => ex.name !== name);
  saveState();
  openSession(currentSessionKey);
  showQuick('Exercice retir√©', '#ffb3b3');
}

function removeExerciseFromSpecificSession(sessionKey, encodedName) {
  const name = decodeURIComponent(encodedName);
  if(!confirm(`Retirer "${name}" de cette s√©ance ?`)) return;
  
  state.program[sessionKey].exercises = state.program[sessionKey].exercises.filter(ex => ex.name !== name);
  saveState();
  document.getElementById('manageSessionExercises').click();
  showQuick('Exercice retir√©', '#ffb3b3');
}

function removeSession(sessionKey){
  if(!confirm(`Supprimer toute la s√©ance ${state.program[sessionKey].title} ?`)) return;
  state.program[sessionKey].exercises = [];
  saveState();
  openSession(sessionKey);
  showQuick('S√©ance vid√©e', '#ffb3b3');
}

function openModifyWeight(encodedName){
  const name = decodeURIComponent(encodedName);
  openModal(`<h3 style="font-weight:800;color:var(--accent)">${name}</h3>
    <div style="margin-top:8px">
      <input id="modalNewWeight" type="number" class="set-input" value="${state.weights[name]||0}" style="width:100%;font-size:20px;padding:12px"/>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn ios primary" onclick="saveWeight('${encodeURIComponent(name)}')">Enregistrer</button>
      <button class="btn ios" onclick="closeModal()">Annuler</button>
    </div>`);
}

function saveWeight(encodedName){
  const name = decodeURIComponent(encodedName);
  const el = document.getElementById('modalNewWeight');
  if(!el) return;
  const v = parseFloat(el.value);
  if(isNaN(v) || v < 0){ alert('Poids invalide'); return; }
  const old = state.weights[name];
  state.weights[name] = v;
  saveState();
  closeModal();
  renderProgramList();
  if(currentSessionKey) openSession(currentSessionKey);
  showQuick(`Poids ${name}: ${old} ‚Üí ${v} kg`, '#10b981');
}

function savePerf(encodedName){
  const name = decodeURIComponent(encodedName);
  const exId = sanitizeId(name);
  const session = state.program[currentSessionKey];
  if(!session) { showQuick('Session introuvable', '#ef4444'); return; }
  const ex = session.exercises.find(e=>e.name===name);
  if(!ex) { showQuick('Exercice introuvable', '#ef4444'); return; }
  let sets = [];
  for(let i=1;i<=ex.sets;i++){
    const wEl = document.querySelector('.w-'+exId+'-'+i);
    const rEl = document.querySelector('.r-'+exId+'-'+i);
    if(!wEl || !rEl) continue;
    const w = parseFloat(wEl.value) || 0;
    const r = parseInt(rEl.value) || 0;
    if(r>0) sets.push({w:w,r:r});
  }
  if(sets.length===0){ showQuick('Entrez au moins une r√©p√©tition', '#ef4444'); return; }
  const best = sets.reduce((a,b)=> b.r > a.r ? b : a, sets[0]);
  if(!state.hist[name]) state.hist[name]=[];
  state.hist[name].push({week:state.week,weight:best.w,reps:best.r,ts:Date.now(),allSets:sets});
  state.weights[name] = best.w;
  saveState();
  showQuick(`‚úÖ ${name}: ${best.r} reps @ ${best.w}kg`);
  setTimeout(()=>{ if(currentSessionKey) openSession(currentSessionKey); },200);
}

let restInterval = null;
let restRemaining = 0, restTotal = 0;
function startRestCountdown(seconds, nextText){
  stopRest();
  restTotal = Math.max(1, Math.floor(seconds));
  restRemaining = restTotal;
  const restBox = document.getElementById('restTimer');
  const txt = document.getElementById('timerText');
  const progress = document.getElementById('timerProgress');
  const nextEl = document.getElementById('nextExerciseName');
  nextEl.textContent = nextText || 'Repos';
  restBox.style.display='flex';
  updateRestUI();
  restInterval = setInterval(()=>{
    restRemaining--;
    updateRestUI();
    if(restRemaining<=0){ stopRest(); showQuick('‚è±Ô∏è Repos termin√©', '#ffb347'); if(navigator.vibrate) navigator.vibrate([60,40,60]); playBeep(); }
  },1000);
}
function stopRest(){ if(restInterval){ clearInterval(restInterval); restInterval=null; } restRemaining=0; restTotal=0; document.getElementById('restTimer').style.display='none'; const prog=document.getElementById('timerProgress'); if(prog) prog.style.strokeDashoffset=214; }
function updateRestUI(){
  const txt = document.getElementById('timerText');
  const progress = document.getElementById('timerProgress');
  const restBox = document.getElementById('restTimer');
  if(!txt || !progress) return;
  const mm = Math.floor(restRemaining/60); const ss = restRemaining%60;
  txt.textContent = `${mm}:${ss<10?('0'+ss):ss}`;
  const ratio = Math.max(0, restRemaining)/Math.max(1, restTotal);
  progress.style.strokeDashoffset = String(Math.round(214 * ratio));
}
document.getElementById('skipTimer').addEventListener('click', ()=>{ stopRest(); showQuick('‚è≠Ô∏è Repos ignor√©', '#ffb347'); });

function playBeep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value = 900; g.gain.value=0.3;
    o.connect(g); g.connect(ctx.destination); o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.4);
    o.stop(ctx.currentTime + 0.5);
  }catch(e){ /* ignore */ }
}

function openModal(html){
  const modal = document.getElementById('modal');
  const inner = document.getElementById('modalInner');
  inner.innerHTML = html;
  modal.classList.add('active'); modal.setAttribute('aria-hidden','false');
}
function closeModal(){ 
  const modal = document.getElementById('modal'); 
  modal.classList.remove('active'); 
  modal.setAttribute('aria-hidden','true'); 
  document.getElementById('modalInner').innerHTML='';
  if(charts.volume) { charts.volume.destroy(); charts.volume = null; }
  if(charts.muscle) { charts.muscle.destroy(); charts.muscle = null; }
}
document.getElementById('modalOverlay').addEventListener('click', closeModal);
document.getElementById('modalClose').addEventListener('click', closeModal);
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

document.getElementById('addCustom').addEventListener('click', ()=> {
  openModal(`<h3 style="font-weight:800;color:var(--accent)">‚ûï Nouvel exercice</h3>
    <div style="display:grid;gap:8px">
      <input id="c_name" class="set-input" placeholder="Nom ex: Split Squat" />
      <select id="c_type" class="set-input"><option>halt√®res</option><option>barre</option><option>machine</option><option>poids du corps</option></select>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><input id="c_sets" class="set-input" type="number" value="3"/><input id="c_reps" class="set-input" value="10"/></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><input id="c_rest" class="set-input" type="number" value="90"/><input id="c_weight" class="set-input" type="number" value="12"/></div>
      <input id="c_tech" class="set-input" value="Standard" placeholder="Technique"/>
      <div class="exercise-actions">
        <button class="btn ios primary" onclick="saveCustom()">Cr√©er</button>
        <button class="btn ios" onclick="closeModal()">Annuler</button>
      </div>
    </div>`);
});
window.saveCustom = function(){
  const n = document.getElementById('c_name').value.trim();
  if(!n){ alert('Nom requis'); return; }
  const newEx = {
    name:n,
    type:document.getElementById('c_type').value,
    sets:parseInt(document.getElementById('c_sets').value)||3,
    reps:document.getElementById('c_reps').value,
    rest:parseInt(document.getElementById('c_rest').value)||90,
    weight:parseFloat(document.getElementById('c_weight').value)||0,
    tech:document.getElementById('c_tech').value||'Standard',
    custom:true
  };
  state.customExercises.push(newEx);
  state.weights[newEx.name]=newEx.weight;
  saveState();
  closeModal();
  document.getElementById('customCount').textContent = `${state.customExercises.length} personnalis√©s`;
  showQuick('Exercice cr√©√© ‚úì','#10b981');
}
document.getElementById('viewCustom').addEventListener('click', ()=> {
  let html = `<h3 style="font-weight:800;color:var(--accent)">Mes exercices</h3><div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">`;
  if(state.customExercises.length===0) html += `<div class="small">Aucun exercice personnalis√©</div>`;
  state.customExercises.forEach((ex,idx)=> html += `
    <div style="padding:12px;background:var(--card-2);border-radius:10px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>${ex.name}</strong>
        <div class="small">${ex.sets}√ó${ex.reps} ‚Ä¢ ${ex.rest}s ‚Ä¢ ${ex.weight}kg ‚Ä¢ ${ex.tech}</div>
      </div>
      <div class="exercise-actions">
        <button class="btn ios danger" onclick="removeCustom(${idx})">Supprimer</button>
      </div>
    </div>`);
  html += `</div><div style="margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`;
  openModal(html);
});
window.removeCustom = function(i){
  if(!confirm('Supprimer cet exercice personnalis√© ?')) return;
  const removed = state.customExercises.splice(i,1);
  saveState();
  closeModal();
  document.getElementById('customCount').textContent = `${state.customExercises.length} personnalis√©s`;
  showQuick('Exercice supprim√©', '#ffb3b3');
}

document.getElementById('manageSessionExercises').addEventListener('click', ()=> {
  let html = `<h3 style="font-weight:800;color:var(--accent)">üìÖ Gestion des S√©ances</h3>
    <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px">`;
  
  Object.values(state.program).forEach(session => {
    html += `<div style="background:var(--card-2);padding:12px;border-radius:10px">
      <div style="font-weight:700;margin-bottom:8px">${session.title}</div>
      <div class="exercise-actions">
        <button class="btn ios" onclick="openAddExerciseModal('${session.key}')">‚ûï Ajouter exercice</button>
        <button class="btn ios danger" onclick="clearSession('${session.key}')">üóëÔ∏è Vider s√©ance</button>
      </div>
      <div style="margin-top:8px;max-height:200px;overflow-y:auto">
        ${session.exercises.map(ex => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid rgba(255,255,255,0.05)">
            <div>
              <div style="font-weight:600">${ex.name}</div>
              <div class="small">${ex.sets}√ó${ex.reps} ‚Ä¢ ${ex.rest}s ‚Ä¢ ${ex.weight}kg</div>
            </div>
            <button class="btn ios danger" style="padding:4px 8px;font-size:12px" onclick="removeExerciseFromSpecificSession('${session.key}','${encodeURIComponent(ex.name)}')">Retirer</button>
          </div>
        `).join('')}
      </div>
    </div>`;
  });
  
  html += `</div><div style="margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`;
  openModal(html);
});

function clearSession(sessionKey) {
  if(!confirm(`Vider toute la s√©ance ${state.program[sessionKey].title} ?`)) return;
  state.program[sessionKey].exercises = [];
  saveState();
  document.getElementById('manageSessionExercises').click();
  showQuick('S√©ance vid√©e', '#ffb3b3');
}

function openStatsModal(){
  openModal(`<h3 style="font-weight:800;color:var(--accent)">üìä Statistiques ‚Ä¢ Semaine ${state.week}</h3>
    <div class="stats-grid">
      <div class="chart-container">
        <h4 style="margin-top:0">Volume par s√©ance</h4>
        <canvas id="chartVolume" style="width:100%;height:260px"></canvas>
      </div>
      <div class="chart-container">
        <h4 style="margin-top:0">Muscles (intensit√© relative)</h4>
        <canvas id="chartMuscle" style="width:100%;height:260px"></canvas>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`);
  setTimeout(renderCharts, 60);
}

function renderCharts(){
  const ctxVol = document.getElementById('chartVolume').getContext('2d');
  const ctxMus = document.getElementById('chartMuscle').getContext('2d');
  
  const labels = Object.values(state.program).map(s=> s.title );
  const dataVol = Object.values(state.program).map(s => {
    return s.exercises.reduce((acc,ex)=> {
      const reps = (typeof ex.reps === 'number')?ex.reps:parseInt(String(ex.reps).split('-')[0])||0;
      const w = state.weights[ex.name] || ex.weight || 0;
      return acc + (w * reps * ex.sets);
    },0);
  });

  if(charts.volume) charts.volume.destroy();
  charts.volume = new Chart(ctxVol, {
    type:'bar',
    data:{ 
      labels, 
      datasets:[{ 
        label:`Volume (Semaine ${state.week})`, 
        data:dataVol, 
        backgroundColor:['rgba(255,122,20,0.85)','rgba(255,160,60,0.7)','rgba(255,200,90,0.6)'] 
      }]
    },
    options:{ 
      plugins:{ legend:{display:false} }, 
      scales:{ 
        y:{
          beginAtZero:true,
          ticks:{color:'#fff'},
          grid:{color:'rgba(255,255,255,0.06)'}
        }, 
        x:{
          ticks:{color:'#fff'},
          grid:{display:false}
        } 
      } 
    }
  });

  const allMuscles = [...new Set(Object.values(MUSCLE_MAPPING).flatMap(m=> [...m.primary,...m.secondary,...m.tertiary]))];
  const musValues = allMuscles.map(m=>{
    let total=0;
    Object.values(state.program).forEach(s=>{
      s.exercises.forEach(ex=>{
        const mm = MUSCLE_MAPPING[ex.name];
        if(!mm) return;
        const weight = state.weights[ex.name]||ex.weight||0;
        const reps = (typeof ex.reps === 'number')?ex.reps:parseInt(String(ex.reps).split('-')[0])||0;
        const vol = weight*reps*ex.sets;
        if(mm.primary.includes(m)) total += vol*1.0;
        else if(mm.secondary.includes(m)) total += vol*0.6;
        else if(mm.tertiary.includes(m)) total += vol*0.3;
      });
    });
    return Math.round(total/1000);
  });

  if(charts.muscle) charts.muscle.destroy();
  charts.muscle = new Chart(ctxMus, {
    type:'radar',
    data:{ 
      labels:allMuscles, 
      datasets:[{ 
        label:'Intensit√© relative (k)', 
        data:musValues, 
        fill:true, 
        backgroundColor:'rgba(255,120,0,0.18)', 
        borderColor:'#ff7a18', 
        pointBackgroundColor:'#ffb74d' 
      }]
    },
    options:{ 
      scales:{ 
        r:{
          angleLines:{color:'rgba(255,255,255,0.08)'},
          grid:{color:'rgba(255,255,255,0.06)'},
          pointLabels:{color:'#fff'},
          ticks:{color:'#fff'}
        } 
      }, 
      plugins:{ 
        legend:{
          labels:{color:'#fff'}
        } 
      } 
    }
  });
}

function renderHeatmap(){
  const el = document.getElementById('heatmap'); 
  el.innerHTML='';
  
  const days = 7;
  const dayVolumes = new Array(days).fill(0);
  const sessionDayMap = { dimanche:0, mardi:2, vendredi:5 };
  
  Object.values(state.program).forEach(sess=>{
    const vol = sess.exercises.reduce((acc,ex)=> {
      const reps = (typeof ex.reps === 'number') ? ex.reps : parseInt(String(ex.reps).split('-')[0])||0;
      const w = state.weights[ex.name] || ex.weight || 0;
      return acc + (w*reps*ex.sets);
    },0);
    const dayIndex = sessionDayMap[sess.key] || 0;
    dayVolumes[dayIndex] += vol;
  });
  
  const max = Math.max(...dayVolumes,1);
  for(let d=0;d<days;d++){
    const v = dayVolumes[d];
    const ratio = v / max;
    let cls='c1';
    if(ratio>0.75) cls='c4'; 
    else if(ratio>0.5) cls='c3'; 
    else if(ratio>0.25) cls='c2';
    
    const cell = document.createElement('div');
    cell.className = 'heat-cell '+cls;
    cell.textContent = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][d] + ` ‚Ä¢ ${Math.round(v/1000)}k`;
    el.appendChild(cell);
  }
}

function openVolumeModal(){
  openModal(`<h3 style="font-weight:800;color:var(--accent)">üìà Volume Hebdomadaire</h3>
    <div class="chart-container">
      <canvas id="volumeChart" style="width:100%;height:300px"></canvas>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`);
  
  setTimeout(() => {
    const ctx = document.getElementById('volumeChart').getContext('2d');
    const labels = Object.values(state.program).map(s=> s.title);
    const data = Object.values(state.program).map(s => {
      return s.exercises.reduce((acc,ex)=> {
        const reps = (typeof ex.reps === 'number')?ex.reps:parseInt(String(ex.reps).split('-')[0])||0;
        const w = state.weights[ex.name] || ex.weight || 0;
        return acc + (w * reps * ex.sets);
      },0);
    });
    
    if(window.currentChart) window.currentChart.destroy();
    window.currentChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Volume Total (kg)',
          data: data,
          backgroundColor: [
            'rgba(255, 122, 20, 0.8)',
            'rgba(255, 160, 60, 0.8)',
            'rgba(255, 200, 90, 0.8)'
          ],
          borderColor: [
            'rgb(255, 122, 20)',
            'rgb(255, 160, 60)',
            'rgb(255, 200, 90)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: { color: '#fff' },
            grid: { color: 'rgba(255,255,255,0.06)' }
          },
          x: {
            ticks: { color: '#fff' },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            labels: { color: '#fff' }
          }
        }
      }
    });
  }, 50);
}

function openMuscleModal(){
  openModal(`<h3 style="font-weight:800;color:var(--accent)">üí™ Analyse Musculaire</h3>
    <div class="chart-container">
      <canvas id="muscleChart" style="width:100%;height:300px"></canvas>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`);
  
  setTimeout(() => {
    const ctx = document.getElementById('muscleChart').getContext('2d');
    const muscleGroups = {};
    
    Object.values(state.program).forEach(session => {
      session.exercises.forEach(exercise => {
        const mapping = MUSCLE_MAPPING[exercise.name];
        if (!mapping) return;
        
        const weight = state.weights[exercise.name] || exercise.weight || 0;
        const reps = (typeof exercise.reps === 'number') ? exercise.reps : parseInt(String(exercise.reps).split('-')[0]) || 0;
        const volume = weight * reps * exercise.sets;
        
        mapping.primary.forEach(muscle => {
          muscleGroups[muscle] = (muscleGroups[muscle] || 0) + volume;
        });
      });
    });
    
    const labels = Object.keys(muscleGroups);
    const data = Object.values(muscleGroups);
    
    if(window.currentChart) window.currentChart.destroy();
    window.currentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 122, 20, 0.8)',
            'rgba(255, 160, 60, 0.8)',
            'rgba(255, 200, 90, 0.8)',
            'rgba(245, 158, 11, 0.8)',
            'rgba(255, 193, 7, 0.8)',
            'rgba(255, 152, 0, 0.8)'
          ],
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 2
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'right',
            labels: { color: '#fff' }
          }
        }
      }
    });
  }, 50);
}

document.getElementById('exportCSV').addEventListener('click', ()=>{
  let csv = 'Exercise,Week,Set,Reps,Weight,Date\n';
  Object.entries(state.hist).forEach(([ex,arr])=>{
    arr.forEach(r=>{
      if(r.allSets && r.allSets.length){
        r.allSets.forEach((sidx,s)=>{
          csv += `"${ex}",${r.week},${sidx+1},${s.r},${s.w},"${new Date(r.ts).toLocaleString()}"\n`;
        });
      } else {
        csv += `"${ex}",${r.week},1,${r.reps},${r.weight},"${new Date(r.ts).toLocaleString()}"\n`;
      }
    });
  });
  const blob = new Blob([csv],{type:'text/csv'}); 
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href=url; 
  a.download=`ultimate_export_${new Date().toISOString().slice(0,10)}.csv`; 
  a.click();
  showQuick('CSV export√© ‚úîÔ∏è');
});

document.getElementById('backupBtn').addEventListener('click', ()=> {
  try{
    const payload = JSON.stringify(state,null,2);
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; 
    a.download = `ultimate-v9-backup-${new Date().toISOString().slice(0,10)}.json`; 
    a.click();
  }catch(e){ showQuick('Erreur backup', true) }
});

document.getElementById('resetApp').addEventListener('click', ()=>{
  if(confirm('R√©initialiser toutes les donn√©es ?')){ 
    localStorage.removeItem(STATE_KEY); 
    state = defaultState(); 
    saveState(); 
    renderAll(); 
    showQuick('App r√©initialis√©e', '#ef4444'); 
  }
});

function sanitizeId(name){ return name.replace(/[^a-z0-9]/gi,'_'); }

function renderAll(){
  renderHeader(); 
  renderProgramList(); 
  renderHeatmap();
}

state = loadState();
renderAll();

document.getElementById('nextWeek').addEventListener('click', ()=>{
  state.week = Math.min(26, state.week+1); saveState(); renderAll(); showQuick(`Semaine ${state.week}`);
});
document.getElementById('prevWeek').addEventListener('click', ()=>{
  state.week = Math.max(1, state.week-1); saveState(); renderAll(); showQuick(`Semaine ${state.week}`);
});

document.getElementById('openStats').addEventListener('click', openStatsModal);
document.getElementById('openVolume').addEventListener('click', openVolumeModal);
document.getElementById('openMuscle').addEventListener('click', openMuscleModal);

window.openSession = openSession;
window.savePerf = savePerf;
window.openModifyWeight = openModifyWeight;
window.closeModal = closeModal;

setInterval(()=> saveState(), 20000);

/* ============================
   HEATMAP PREMIUM ‚Äî Weekly load & muscle breakdown
   ============================ */
(function(){
  const DAY_LABELS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  let weekOffset = 0;

  function getWeekRange(offset=0){
    const now = new Date();
    const monday = new Date(now);
    monday.setDate(now.getDate() - now.getDay() + 1 + offset*7);
    monday.setHours(0,0,0,0);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate()+6);
    sunday.setHours(23,59,59,999);
    return {monday,sunday};
  }

  function formatWeekLabel(offset=0){
    const r = getWeekRange(offset);
    const a = r.monday.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
    const b = r.sunday.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
    return `${a} ‚Äî ${b}`;
  }

  function computeWeekData(offset=0){
    const {monday,sunday} = getWeekRange(offset);
    const hist = window.state?.hist || {};
    const days = Array.from({length:7},()=>({volume:0,muscles:{}}));

    // Parcourir l'historique pour trouver les s√©ances dans la semaine
    Object.entries(hist).forEach(([exerciseName, sessions])=>{
      sessions.forEach(session=>{
        const date = new Date(session.ts);
        if(isNaN(date)) return;
        if(date < monday || date > sunday) return;
        const idx = (date.getDay()+6)%7; // Lundi=0, Dimanche=6
        
        // Calculer le volume pour cet exercice
        const reps = session.reps || 0;
        const weight = session.weight || 0;
        const volume = reps * weight;
        days[idx].volume += volume;
        
        // Identifier le muscle principal
        const muscleMapping = MUSCLE_MAPPING[exerciseName];
        if(muscleMapping){
          const primaryMuscle = muscleMapping.primary[0] || 'Autre';
          days[idx].muscles[primaryMuscle] = (days[idx].muscles[primaryMuscle] || 0) + 1;
        }
      });
    });
    
    return days;
  }

  function colorByRatio(r){
    if(r <= 0.01) return '#20232A';
    if(r < 0.25) return '#FFECB3';
    if(r < 0.5) return '#FFB74D';
    if(r < 0.75) return '#FF8A00';
    return '#F59E0B';
  }

  function renderHeatmap(offset=0){
    const grid=document.getElementById('heatmapGrid');
    const label=document.getElementById('heatWeekLabel');
    if(!grid) return;
    grid.innerHTML='';
    label.textContent=formatWeekLabel(offset);

    const data=computeWeekData(offset);
    const max=Math.max(...data.map(d=>d.volume),1);
    data.forEach((d,i)=>{
      const v = d.volume;
      const ratio = v / max;
      const color = colorByRatio(ratio);
      
      const cell=document.createElement('div');
      cell.className='heat-cell';
      cell.style.background=color;
      cell.innerHTML=`<div>${DAY_LABELS[i]}</div><div>${Math.round(v/100)/10}k</div>`;
      
      const topMuscle=Object.entries(d.muscles).sort((a,b)=>b[1]-a[1])[0];
      if(topMuscle && topMuscle[1] > 0){
        const badge=document.createElement('div');
        badge.className='heat-badge';
        badge.textContent=topMuscle[0].substring(0,3);
        cell.style.position='relative';
        cell.appendChild(badge);
      }
      
      cell.onclick=()=>{
        const muscleText = topMuscle ? `‚Ä¢ Muscle: ${topMuscle[0]}` : '';
        alert(`${DAY_LABELS[i]} ‚Ä¢ Volume: ${(Math.round(v/100)/10)}k ${muscleText}`);
      };
      grid.appendChild(cell);
    });
  }

  document.getElementById('heatPrev').onclick=()=>{weekOffset--;renderHeatmap(weekOffset)};
  document.getElementById('heatNext').onclick=()=>{weekOffset++;renderHeatmap(weekOffset)};
  document.addEventListener('DOMContentLoaded',()=>renderHeatmap(0));
})();
</script>
</body>
</html>
