<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>üèÜ HYBRID MASTER 51 ‚Äî Ultimate V6</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#0b0f17;
  --card:#0f1620;
  --card-2:#151a25;
  --accent:#F59E0B;
  --accent-2:#ff8a00;
  --muted:#8b92a8;
  --success:#10b981;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.02);
  --neon: rgba(245,158,11,0.18);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#06070a 0%, #0b0f17 100%);color:#fff;font-family:Inter, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;}
.container{max-width:1100px;margin:18px auto;padding:18px;}
.header{display:flex;align-items:center;gap:14px}
.logo{font-size:40px}
.title{font-size:22px;font-weight:800;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;color:transparent}
.row{display:flex;gap:12px;align-items:center}
.card{background:var(--card);border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.left{flex:1}
.right{width:360px}
.programs{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:18px}
.session-list{display:flex;flex-direction:column;gap:12px}
.session-btn{background:linear-gradient(135deg,var(--accent),var(--accent-2));border:none;padding:16px;border-radius:12px;color:#071021;font-weight:800;cursor:pointer;box-shadow:0 8px 24px rgba(245,158,11,0.12);text-align:left}
.small{font-size:13px;color:var(--muted)}
.dashboard-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.btn{background:var(--card-2);border:1px solid rgba(255,255,255,0.03);color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#071021;font-weight:700;border:none}
.week-card{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:16px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border:1px solid rgba(255,255,255,0.03)}
.exercise-list{display:flex;flex-direction:column;gap:12px;margin-top:14px}
.exercise-card{border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,var(--card),var(--card-2))}
.exercise-header{display:flex;justify-content:space-between;align-items:center;padding:14px;cursor:pointer}
.exercise-name{font-weight:800;color:var(--accent)}
.exercise-meta{color:var(--muted);font-size:13px}
.exercise-details{max-height:0;overflow:hidden;transition:max-height .35s;padding:0 14px;background:rgba(255,255,255,0.01)}
.exercise-details.open{max-height:1200px;padding:14px}
.set-row{display:grid;grid-template-columns:50px 1fr 1fr 44px;gap:6px;padding:6px;background:var(--glass);border-radius:10px;align-items:center;margin-bottom:6px}
.set-input{background:transparent;border:2px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:#fff;font-weight:700;text-align:center;font-size:13px}
.set-checkbox{display:none}
.set-checkbox+label{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--card-2);font-size:12px}
.set-checkbox:checked+label{background:var(--success);border-color:var(--success);transform:scale(1.08)}
.technique-banner{background:linear-gradient(135deg,var(--neon), rgba(251,191,36,0.08));border:1px solid rgba(245,158,11,0.2);padding:10px;border-radius:10px;color:var(--accent);font-weight:700;margin-bottom:12px;text-align:center}

.rest-timer{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--card);padding:14px;border-radius:18px;border:1px solid rgba(255,255,255,0.04);display:flex;align-items:center;gap:12px;z-index:999;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.timer-circle{width:72px;height:72px;position:relative}
.timer-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)}
.timer-skip{background:transparent;border:2px solid rgba(239,68,68,0.25);color:var(--danger);width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;z-index:1200}
.modal.active{display:flex}
.modal .overlay{position:absolute;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.modal .content{position:relative;background:var(--card);padding:18px;border-radius:12px;max-width:940px;width:100%;border:1px solid rgba(255,255,255,0.04);max-height:80vh;overflow:auto;-webkit-overflow-scrolling: touch;}
.close-x{position:absolute;right:12px;top:12px;cursor:pointer;color:var(--accent)}

.charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.chart-container{background:var(--card-2);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.heatmap-canvas{width:100%;height:300px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:10px;padding:8px}

.footer{margin-top:30px;color:var(--muted);font-size:13px;text-align:center}

.heatmap{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:8px}
.heat-cell{background:rgba(255,255,255,0.02);height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)}
.heat-cell.c1{background:rgba(255,120,0,0.06)}
.heat-cell.c2{background:rgba(255,120,0,0.12)}
.heat-cell.c3{background:rgba(255,120,0,0.22)}
.heat-cell.c4{background:rgba(255,120,0,0.34)}
.heat-legend{display:flex;gap:6px;align-items:center;margin-top:8px}
.legend-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:12px}

.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:700px){.stats-grid{grid-template-columns:1fr}}

@media (max-width:430px){
  .container{padding:12px;margin:12px auto}
  .programs{grid-template-columns:1fr; gap:12px}
  .right{width:100%}
  .set-row{grid-template-columns:45px 1fr 1fr 40px; gap:4px; padding:4px}
  .set-input{padding:4px; font-size:12px}
  .set-checkbox+label{width:32px;height:32px;font-size:11px}
  .exercise-header{padding:12px}
  .exercise-details.open{padding:12px}
  .session-btn{padding:14px}
  .btn{padding:8px 10px; font-size:13px}
  .dashboard-actions{gap:6px}
}

@media (max-width:980px){
  .programs{grid-template-columns:1fr; }
  .right{width:100%}
  .charts{grid-template-columns:1fr}
  .stats-grid{grid-template-columns:1fr}
}

.muscle-tag{padding:4px 8px;border-radius:6px;font-size:11px;font-weight:600}

.exercise-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.btn.ios{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:12px;padding:12px 16px;font-weight:600}
.btn.ios.primary{background:linear-gradient(135deg,#007AFF,#5856D6);color:white;border:none}
.btn.ios.danger{background:linear-gradient(135deg,#FF3B30,#FF2D55);color:white;border:none}
.session-btn.ios{background:linear-gradient(135deg,#34C759,#32D74B);color:white;font-weight:700;border:none;box-shadow:0 4px 20px rgba(52,199,89,0.3)}

@supports(padding:max(0px)){
  .container{
    padding-left:max(12px,env(safe-area-inset-left));
    padding-right:max(12px,env(safe-area-inset-right));
    padding-bottom:max(12px,env(safe-area-inset-bottom));
  }
}

/* Correction iPhone 15 Pro Max : affichage complet des cases s√©rie */
@supports (-webkit-touch-callout: none) {
  .exercise-details {
    overflow-y: visible !important;
  }
  .set-row {
    overflow: visible !important;
  }
  input.set-checkbox + label {
    min-width: 40px;
    min-height: 40px;
  }
}

/* Styles pour les supersets */
.superset-group {
  background: rgba(245, 158, 11, 0.05);
  border: 1px solid rgba(245, 158, 11, 0.1);
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 8px;
}

.superset-header {
  color: var(--accent);
  font-weight: 700;
  font-size: 12px;
  margin-bottom: 8px;
  text-align: center;
}

/* ============================
   HEATMAP PREMIUM ‚Äî Dark+Glass Edition
   ============================ */

  /* ---- Glass + Glow styling ---- */
  #heatmapPremium {
    margin-top:18px;
    background:rgba(10,14,22,0.55);
    backdrop-filter:blur(18px) saturate(180%);
    border-radius:20px;
    padding:18px;
    border:1px solid rgba(255,255,255,0.05);
    box-shadow:0 8px 32px rgba(0,0,0,0.6);
  }
  #heatmapPremium .title {
    font-weight:900;
    color:var(--accent,#F59E0B);
    margin-bottom:12px;
    text-shadow:0 0 12px rgba(255,160,30,0.4);
    font-size:18px;
  }
  .hm-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .weekNav button {
    background:rgba(255,255,255,0.08);
    border:1px solid rgba(255,255,255,0.08);
    padding:8px 12px;
    border-radius:10px;
    color:#fff;
    font-weight:600;
    backdrop-filter:blur(8px);
    cursor:pointer;
    transition:all .2s;
  }
  .weekNav button:hover {
    background:rgba(255,255,255,0.18);
    transform:translateY(-2px);
  }
  .legendPill {
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.1);
    color:#bfc9d9;
    padding:6px 10px;
    border-radius:8px;
    font-size:13px;
  }

  .weekCol {
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
    min-width:86px;
  }
  .weekLabel {
    font-size:13px;
    color:#8a97b5;
    margin-bottom:4px;
  }

  .dayCell {
    width:72px;
    height:52px;
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    position:relative;
    cursor:pointer;
    transition:all .18s ease;
    box-shadow:inset 0 0 10px rgba(0,0,0,0.3);
  }
  .dayCell:hover {
    transform:scale(1.08);
    box-shadow:0 0 16px rgba(255,255,255,0.12);
  }

  /* ---- Color intensities ---- */
  .c-none { background:rgba(20,24,32,0.8); color:#777; }
  .c-low  { background:linear-gradient(135deg,#1e293b,#334155); box-shadow:inset 0 0 10px rgba(88,168,255,0.3); }
  .c-mid  { background:linear-gradient(135deg,#0ea5e9,#2563eb); box-shadow:inset 0 0 15px rgba(59,130,246,0.4); }
  .c-high { background:linear-gradient(135deg,#f59e0b,#f97316); color:#000; box-shadow:0 0 18px rgba(245,158,11,0.6); }
  .c-max  { background:linear-gradient(135deg,#ef4444,#f59e0b); color:#000; box-shadow:0 0 22px rgba(239,68,68,0.6); }

  .hm-small {
    font-size:11px;
    color:rgba(255,255,255,0.8);
    margin-top:3px;
  }
  .hm-tooltip {
    position:absolute;
    z-index:9999;
    background:rgba(10,12,17,0.92);
    color:#fff;
    padding:8px 10px;
    border-radius:8px;
    font-size:13px;
    border:1px solid rgba(255,255,255,0.08);
    box-shadow:0 8px 32px rgba(0,0,0,0.6);
    pointer-events:none;
    transform:translate(-50%,-110%);
    white-space:nowrap;
  }
  @media (max-width:720px) {
    .dayCell { width:60px; height:44px; font-size:12px; }
    .weekCol { min-width:70px; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="header row">
    <div class="logo">üèÜ</div>
    <div>
      <div class="title">HYBRID MASTER 51 ‚Äî Ultimate V6</div>
      <div class="small">26 semaines ¬∑ 3 s√©ances / semaine ¬∑ Analyse & Heatmap</div>
    </div>
    <button class="btn ios" onclick="openDayExerciseManager()">üß© G√©rer les exercices</button>
  </div>

  <div class="programs">
    <div class="left">
      <div class="week-card card row">
        <div>
          <div style="font-weight:800">Semaine <span id="weekDisplay">1</span></div>
          <div class="small" id="blockName">Bloc</div>
        </div>
        <div class="row">
          <button id="prevWeek" class="btn ios">‚Üê Pr√©c.</button>
          <button id="nextWeek" class="btn ios primary">Suiv. ‚Üí</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div style="font-weight:800">S√©ances disponibles</div>
          <div class="small">Tap pour ouvrir</div>
        </div>
        <div class="session-list" id="progList" style="margin-top:12px"></div>
      </div>

      <div class="exercise-list" id="exerciseArea" style="margin-top:14px"></div>
    </div>

    <div class="right">
      <div class="card">
        <div style="font-weight:800">Tableau de bord</div>
        <div class="small" id="quickMsg" style="margin-top:8px">Pr√™t.</div>
        <div class="dashboard-actions" style="margin-top:12px;">
          <button id="openStats" class="btn ios">üìä Statistiques</button>
          <button id="openVolume" class="btn ios">üìà Volume</button>
          <button id="openMuscle" class="btn ios">üí™ Muscles</button>
          <button id="exportCSV" class="btn ios">üíæ Export</button>
          <button id="backupBtn" class="btn ios">‚òÅÔ∏è Backup</button>
          <button id="resetApp" class="btn ios" style="color:var(--danger)">‚ö†Ô∏è Reset</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:800;margin-bottom:8px">Heatmap de charge (semaine)</div>
        <div id="heatmapContainer">
          <div id="heatmap" class="heatmap" aria-hidden="false"></div>
          <div class="heat-legend">
            <div class="legend-pill c1" style="background:rgba(255,120,0,0.06)">Faible</div>
            <div class="legend-pill c2" style="background:rgba(255,120,0,0.12)">Moyen</div>
            <div class="legend-pill c3" style="background:rgba(255,120,0,0.22)">Haut</div>
            <div class="legend-pill c4" style="background:rgba(255,120,0,0.34)">Max</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:800">Gestion des Exercices</div>
        <div class="small" style="margin-top:8px" id="customCount">0 personnalis√©s</div>
        <div style="margin-top:8px">
          <button id="addCustom" class="btn ios">‚ûï Ajouter exercice</button>
          <button id="viewCustom" class="btn ios">üëÅ Voir</button>
          <button id="manageSessionExercises" class="btn ios">üìÖ G√©rer s√©ances</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Heatmap Premium Dark+Glass -->
  <div id="heatmapPremium" class="card">
    <div class="title">Heatmap ‚Ä¢ Charge d'entra√Ænement (4 semaines)</div>
    <div class="hm-header">
      <div class="weekNav">
        <button id="hmPrev">‚Äπ</button>
        <div class="legendPill" id="hmRangeLabel">Semaine actuelle</div>
        <button id="hmNext">‚Ä∫</button>
      </div>
      <div style="display:flex;gap:6px;align-items:center;">
        <div class="legendPill">Volume</div>
        <div class="legendPill">S√©ries</div>
      </div>
    </div>

    <div id="heatmapGrid" style="margin-top:14px;"></div>

    <div class="hm-legend" style="margin-top:12px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;">
      <div class="legendPill">√âchelle</div>
      <div class="legendPill" style="background:#1e293b;">Faible</div>
      <div class="legendPill" style="background:#2563eb;">Moyen</div>
      <div class="legendPill" style="background:#f59e0b;color:#000;">Haut</div>
      <div class="legendPill" style="background:#ef4444;color:#000;">Max</div>
    </div>
  </div>

  <div class="footer">¬© 2025 ‚Äî HYBRID MASTER 51 ‚Äî Ultimate V6</div>
</div>

<div id="restTimer" class="rest-timer" style="display:none">
  <div class="timer-circle">
    <svg width="72" height="72" viewBox="0 0 80 80">
      <circle cx="40" cy="40" r="34" stroke="rgba(255,255,255,0.06)" stroke-width="6" fill="none"/>
      <circle id="timerProgress" cx="40" cy="40" r="34" stroke="url(#g1)" stroke-width="6" fill="none" stroke-linecap="round" style="stroke-dasharray:214;stroke-dashoffset:214;transform:rotate(-90deg);transform-origin:50% 50%"></circle>
      <defs><linearGradient id="g1"><stop offset="0" stop-color="#F59E0B"/><stop offset="1" stop-color="#ff8a00"/></linearGradient></defs>
    </svg>
    <div class="timer-text" id="timerText">0:00</div>
  </div>
  <div>
    <div style="font-weight:800" id="nextExerciseName">Repos</div>
    <div class="small">Temps restant</div>
  </div>
  <button id="skipTimer" class="timer-skip">‚úï</button>
</div>

<div id="modal" class="modal" aria-hidden="true">
  <div class="overlay" id="modalOverlay"></div>
  <div class="content" id="modalContent">
    <div class="close-x" id="modalClose">‚úñ</div>
    <div id="modalInner"></div>
  </div>
</div>

<script>
// === CORRECTIONS DU PROGRAMME ===
// Structure corrig√©e selon le programme HYBRID MASTER 51

const MUSCLE_MAPPING = {
  "Trap Bar Deadlift": { primary:["Ischios","Fessiers","Dos"], secondary:["Quadriceps","Abdominaux"], tertiary:["Mollets","Avant-bras"] },
  "Goblet Squat": { primary:["Quadriceps","Fessiers"], secondary:["Ischios","Abdominaux"], tertiary:["Mollets"] },
  "Leg Press": { primary:["Quadriceps","Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Lat Pulldown (prise large)": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Landmine Press": { primary:["√âpaules","Triceps"], secondary:["Pectoraux"], tertiary:[] },
  "Rowing Machine (prise large)": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Spider Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Incline Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Cable Pushdown": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Dumbbell Press": { primary:["Pectoraux"], secondary:["Triceps","√âpaules"], tertiary:[] },
  "Cable Fly (poulies moyennes)": { primary:["Pectoraux"], secondary:[], tertiary:[] },
  "Leg Press l√©ger": { primary:["Quadriceps"], secondary:["Ischios","Fessiers"], tertiary:["Mollets"] },
  "Extension Triceps Corde": { primary:["Triceps"], secondary:["Avant-bras"], tertiary:[] },
  "Lateral Raises": { primary:["√âpaules lat√©rales"], secondary:["Trap√®zes"], tertiary:[] },
  "Face Pull": { primary:["√âpaules post√©rieures","Trap√®zes"], secondary:["Dos"], tertiary:[] },
  "Overhead Extension (corde, assis)": { primary:["Triceps longs"], secondary:[], tertiary:[] },
  "Landmine Row": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] },
  "Leg Curl": { primary:["Ischios"], secondary:["Fessiers"], tertiary:["Mollets"] },
  "Leg Extension": { primary:["Quadriceps"], secondary:[], tertiary:[] },
  "Dumbbell Fly": { primary:["Pectoraux"], secondary:["√âpaules"], tertiary:[] },
  "EZ Bar Curl": { primary:["Biceps"], secondary:["Avant-bras"], tertiary:[] },
  "Wrist Curl": { primary:["Avant-bras"], secondary:[], tertiary:[] },
  "Hammer Curl": { primary:["Biceps","Avant-bras"], secondary:[], tertiary:[] },
  "Rowing Machine (prise serr√©e)": { primary:["Dos"], secondary:["Biceps"], tertiary:["Avant-bras"] }
};

// === PROGRAMME CORRIG√â ===
const PROGRAM = {
  dimanche: {
    key:'dimanche', 
    title: "Dimanche - DOS + JAMBES LOURDES + BRAS (68 min)",
    exercises:[
      { name:"Trap Bar Deadlift", sets:5, reps:"6-8", rest:120, weight:75, type:"barre", tech:"RPE 6-8", progression: "+5 kg / 3 sem" },
      { name:"Goblet Squat", sets:4, reps:"10", rest:75, weight:25, type:"halt√®res", tech:"Tempo 3-1-2", progression: "+2.5 kg / 2 sem" },
      { name:"Leg Press", sets:4, reps:"10", rest:75, weight:110, type:"machine", tech:"Drop-set derni√®re s√©rie", progression: "+10 kg / 2 sem" },
      { name:"SUPERSET: Lat Pulldown (prise large) + Landmine Press", sets:4, reps:"10", rest:90, weight:60, type:"superset", tech:"Myo-reps", progression: "+2.5 kg / 2 sem" },
      { name:"Rowing Machine (prise large)", sets:4, reps:"10", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2", progression: "+2.5 kg / 2 sem" },
      { name:"SUPERSET: Spider Curl / Incline Curl* + Cable Pushdown", sets:4, reps:"12", rest:75, weight:12, type:"superset", tech:"Rest-pause", progression: "+2.5 kg / 3 sem" }
    ]
  },
  mardi: {
    key:'mardi', 
    title:"Mardi - PECS + √âPAULES + TRICEPS (70 min)",
    exercises:[
      { name:"Dumbbell Press", sets:5, reps:"10", rest:105, weight:22, type:"halt√®res", tech:"Cluster sets", progression: "+2.5 kg / 3 sem" },
      { name:"Cable Fly (poulies moyennes)", sets:4, reps:"12", rest:60, weight:10, type:"machine", tech:"Tension continue", progression: "+2.5 kg / 3 sem" },
      { name:"Leg Press l√©ger", sets:3, reps:"15", rest:60, weight:80, type:"machine", tech:"Standard", progression: "+10 kg / 3 sem" },
      { name:"SUPERSET: Extension Triceps Corde + Lateral Raises", sets:5, reps:"12", rest:75, weight:20, type:"superset", tech:"Drop-set", progression: "+2.5 kg / 3 sem" },
      { name:"Face Pull", sets:5, reps:"15", rest:60, weight:20, type:"machine", tech:"Tempo 3-1-2", progression: "+2.5 kg / 3 sem" },
      { name:"Rowing Machine (prise serr√©e)", sets:4, reps:"12", rest:75, weight:50, type:"machine", tech:"Tempo 2-1-2", progression: "+2.5 kg / 2 sem" },
      { name:"Overhead Extension (corde, assis)", sets:4, reps:"12", rest:60, weight:15, type:"machine", tech:"Rest-pause", progression: "+2.5 kg / 3 sem" }
    ]
  },
  vendredi: {
    key:'vendredi', 
    title:"Vendredi - DOS + JAMBES L√âG√àRES + BRAS + √âPAULES (73 min)",
    exercises:[
      { name:"Landmine Row", sets:5, reps:"10", rest:105, weight:55, type:"barre", tech:"Tempo 2-1-2", progression: "+2.5 kg / 2 sem" },
      { name:"SUPERSET: Leg Curl + Leg Extension", sets:5, reps:"12", rest:75, weight:40, type:"superset", tech:"Drop-set derni√®re s√©rie", progression: "+5 kg / 3 sem" },
      { name:"SUPERSET: Cable Fly + Dumbbell Fly", sets:4, reps:"15", rest:60, weight:10, type:"superset", tech:"Tension continue", progression: "+2.5 kg / 3 sem" },
      { name:"SUPERSET: EZ Bar Curl + Overhead Extension", sets:5, reps:"12", rest:75, weight:25, type:"superset", tech:"Rest-pause", progression: "+2.5 kg / 3 sem" },
      { name:"Lateral Raises", sets:3, reps:"15", rest:60, weight:8, type:"halt√®res", tech:"Myo-reps", progression: "+2.5 kg / 4 sem" },
      { name:"Wrist Curl", sets:3, reps:"20", rest:45, weight:30, type:"barre", tech:"Standard", progression: "+2.5 kg / 4 sem" }
    ]
  }
};

// === FONCTIONS DE PROGRESSION AUTOMATIQUE ===
function calculateProgression(exerciseName, currentWeek) {
  const exercise = Object.values(PROGRAM).flatMap(s => s.exercises).find(e => e.name.includes(exerciseName));
  if (!exercise || !exercise.progression) return 0;
  
  const progression = exercise.progression;
  const match = progression.match(/\+([\d.]+)\s*kg\s*\/\s*(\d+)\s*sem/);
  if (!match) return 0;
  
  const increment = parseFloat(match[1]);
  const weeksPerIncrement = parseInt(match[2]);
  
  // Appliquer les deloads (semaines 6, 12, 18, 24, 26)
  const deloadWeeks = [6, 12, 18, 24, 26];
  if (deloadWeeks.includes(currentWeek)) {
    return -0.4; // -40% pour les deloads
  }
  
  return Math.floor(currentWeek / weeksPerIncrement) * increment;
}

function getCurrentWeight(exerciseName, baseWeight, currentWeek) {
  const progression = calculateProgression(exerciseName, currentWeek);
  if (progression < 0) {
    // Deload: r√©duire de 40%
    return Math.round(baseWeight * (1 + progression) * 2) / 2;
  }
  return baseWeight + progression;
}

// === FONCTIONS EXISTANTES (avec modifications) ===
function openDayExerciseManager() {
  const dayKeys = Object.keys(state.program);
  let html = `<h3 style="font-weight:800;color:var(--accent)">‚öôÔ∏è G√©rer les exercices par jour</h3>`;
  dayKeys.forEach(k => {
    const s = state.program[k];
    html += `<div style="padding:10px;background:var(--card-2);border-radius:10px;margin-top:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>${s.title}</strong><div class="small">${s.exercises.length} ex.</div></div>
        <div class="exercise-actions">
          <button class="btn ios" onclick="openAddExerciseModal('${k}')">‚ûï Ajouter</button>
          <button class="btn ios danger" onclick="removeSession('${k}')">üóëÔ∏è Vider</button>
        </div>
      </div>
    </div>`;
  });
  html += `<div style="margin-top:12px"><button class="btn ios primary" onclick="closeModal()">Fermer</button></div>`;
  openModal(html);
}

const STATE_KEY = 'hm51_v_full_v6';
let state = null;
let currentSessionKey = null;
let timer = { interval:null, remaining:0, total:0 };
let charts = { volume: null, muscle: null };
let quickTimer;

function defaultState(){
  const weights = {};
  Object.values(PROGRAM).forEach(s => s.exercises.forEach(e => { 
    weights[e.name]=e.weight; 
  }));
  return {
    week:1,
    program: JSON.parse(JSON.stringify(PROGRAM)),
    weights: weights,
    hist:{},
    customExercises: [],
    baseWeights: {...weights} // Stocker les poids de base pour la progression
  };
}

function loadState(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(raw) {
      const loaded = JSON.parse(raw);
      // S'assurer que les poids de base existent
      if (!loaded.baseWeights) {
        loaded.baseWeights = {...loaded.weights};
      }
      return loaded;
    }
  }catch(e){ console.error("loadState err",e) }
  return defaultState();
}

function saveState(){
  try{ 
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
  }catch(e){ console.error("saveState err",e) }
}

function showQuick(msg, color){
  const el = document.getElementById('quickMsg');
  if(!el) return;
  el.textContent = msg;
  el.style.color = color || '';
  clearTimeout(quickTimer);
  quickTimer = setTimeout(()=>{ el.textContent='Pr√™t.'; el.style.color=''; }, 2800);
}

function renderHeader(){
  document.getElementById('weekDisplay').textContent = state.week;
  const blockName = document.getElementById('blockName');
  if(state.week<=5) blockName.textContent = 'Bloc 1 - Fondation ‚Ä¢ Tempo contr√¥l√©';
  else if(state.week<=11) blockName.textContent = 'Bloc 2 - Surcharge ‚Ä¢ Rest-Pause';
  else if(state.week<=17) blockName.textContent = 'Bloc 3 - Surcompensation ‚Ä¢ Drop-sets + Myo-reps';
  else blockName.textContent = 'Bloc 4 - Intensification ‚Ä¢ Clusters + Partials';
}

function renderProgramList(){
  const list = document.getElementById('progList');
  list.innerHTML = '';
  Object.values(state.program).forEach(s=>{
    const totalSets = s.exercises.reduce((a,b)=>a+b.sets,0);
    const btn = document.createElement('button');
    btn.className='session-btn ios';
    btn.innerHTML = `<div style="font-weight:800">${s.title}</div><div class="small">${s.exercises.length} ex ‚Ä¢ ${totalSets} s√©ries</div>`;
    btn.onclick = ()=> openSession(s.key);
    list.appendChild(btn);
  });
  document.getElementById('customCount').textContent = `${state.customExercises.length} personnalis√©s`;
}

function openSession(key){
  currentSessionKey = key;
  const arr = state.program[key].exercises;
  const area = document.getElementById('exerciseArea');
  area.innerHTML = '';
  
  const sessionHeader = document.createElement('div');
  sessionHeader.className = 'card';
  sessionHeader.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:800">${state.program[key].title}</div>
      <div class="exercise-actions">
        <button class="btn ios" onclick="openAddExerciseModal('${key}')">‚ûï Ajouter</button>
        <button class="btn ios danger" onclick="removeSession('${key}')">üóëÔ∏è Supprimer</button>
      </div>
    </div>
  `;
  area.appendChild(sessionHeader);
  
  arr.forEach((ex, index)=>{
    // Calculer le poids actuel avec progression
    const currentWeight = getCurrentWeight(ex.name, state.baseWeights[ex.name] || ex.weight, state.week);
    state.weights[ex.name] = currentWeight; // Mettre √† jour le poids actuel
    
    const exId = sanitizeId(ex.name);
    const card = document.createElement('div'); 
    card.className='exercise-card';
    
    // V√©rifier si c'est un superset
    if (ex.type === 'superset') {
      card.classList.add('superset-group');
    }
    
    const header = document.createElement('div'); 
    header.className='exercise-header';
    header.innerHTML = `<div style="flex:1">
      <div class="exercise-name">${ex.name}</div>
      <div class="exercise-meta">${ex.sets}√ó ${ex.reps} ‚Ä¢ ${ex.rest}s repos ‚Ä¢ ${currentWeight}kg</div>
      ${ex.progression ? `<div class="small" style="color:var(--success)">${ex.progression}</div>` : ''}
    </div>
    <div class="exercise-arrow" id="arrow-${exId}">‚ñº</div>`;
    header.addEventListener('click', ()=> toggleDetails(ex));
    const details = document.createElement('div'); 
    details.className='exercise-details'; 
    details.id='details-'+exId;
    card.appendChild(header); 
    card.appendChild(details);
    area.appendChild(card);
  });
  window.scrollTo({top:0,behavior:'smooth'});
  showQuick('S√©ance ouverte');
}

function toggleDetails(ex){
  const exId = sanitizeId(ex.name);
  const details = document.getElementById('details-'+exId);
  const arrow = document.getElementById('arrow-'+exId);
  if(!details) return;
  const isOpen = details.classList.contains('open');
  document.querySelectorAll('.exercise-details.open').forEach(d=>{
    if(d!==details) { 
      d.classList.remove('open'); 
      d.innerHTML=''; 
      const aid = d.id.replace('details-',''); 
      const ar = document.getElementById('arrow-'+aid); 
      if(ar) ar.classList.remove('open'); 
    }
  });
  if(isOpen){ 
    details.classList.remove('open'); 
    details.innerHTML=''; 
    if(arrow) arrow.classList.remove('open'); 
    return; 
  }
  renderExerciseDetails(ex);
  details.classList.add('open');
  if(arrow) arrow.classList.add('open');
}

function renderExerciseDetails(ex){
  const exId = sanitizeId(ex.name);
  const details = document.getElementById('details-'+exId);
  if(!details) return;
  
  const currentWeight = getCurrentWeight(ex.name, state.baseWeights[ex.name] || ex.weight, state.week);
  const last = (state.hist[ex.name] && state.hist[ex.name].length) ? state.hist[ex.name][state.hist[ex.name].length-1] : null;
  
  let perfHtml = '';
  if(last) perfHtml = `<div style="background:rgba(16,185,129,0.08);padding:10px;border-radius:8px;border:1px solid rgba(16,185,129,0.12);margin-bottom:10px">Derni√®re: ${last.weight}kg √ó ${last.reps} reps (Semaine ${last.week})</div>`;
  else perfHtml = `<div style="background:${'rgba(245,158,11,0.06)'};padding:10px;border-radius:8px;border:1px solid rgba(245,158,11,0.08);margin-bottom:10px">Premi√®re fois pour cet exercice</div>`;

  const mm = MUSCLE_MAPPING[ex.name] || {primary:[],secondary:[],tertiary:[]};
  let muscleHtml = '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">';
  mm.primary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(245,158,11,0.22);color:var(--accent)">${m}</span>`);
  mm.secondary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(59,130,246,0.12);color:#60a5fa">${m}</span>`);
  mm.tertiary.forEach(m=> muscleHtml += `<span class="muscle-tag" style="background:rgba(139,92,246,0.08);color:#b794f4">${m}</span>`);
  muscleHtml += '</div>';

  let setsHtml = '';
  for(let i=1;i<=ex.sets;i++){
    setsHtml += `<div class="set-row">
      <div class="set-label" style="font-size:12px;color:var(--muted)">S√©rie ${i}</div>
      <div><input class="set-input w-${exId}-${i}" type="number" step="0.5" value="${currentWeight}" placeholder="KG"></div>
      <div><input class="set-input r-${exId}-${i}" type="number" value="${(typeof ex.reps==='number')?ex.reps:parseInt(String(ex.reps).split('-')[0])}" placeholder="REPS"></div>
      <div><input id="s-${i}-${exId}" class="set-checkbox" type="checkbox"><label for="s-${i}-${exId}">‚úì</label></div>
    </div>`;
  }

  details.innerHTML = `<div class="technique-banner">‚ú® ${ex.tech}${getTechniqueByWeek()}</div>
    ${perfHtml}
    ${muscleHtml}
    ${setsHtml}
    <div class="exercise-actions">
      <button class="btn ios" onclick="openModifyWeight('${encodeURIComponent(ex.name)}')">‚úèÔ∏è Poids</button>
      <button class="btn ios primary" onclick="savePerf('${encodeURIComponent(ex.name)}')">üíæ Enregistrer</button>
      <button class="btn ios danger" onclick="removeExerciseFromSession('${encodeURIComponent(ex.name)}')">üóëÔ∏è Retirer</button>
    </div>`;

  const checkboxes = details.querySelectorAll('.set-checkbox');
  checkboxes.forEach((cb, idx)=>{
    cb.addEventListener('change', function(){
      if(this.checked){
        if(navigator.vibrate) navigator.vibrate(50);
        const isLast = idx === checkboxes.length - 1;
        const nextText = isLast ? 'Prochain exercice' : 'Repos';
        startRestCountdown(ex.rest, nextText);
      }
    });
  });
}

function getTechniqueByWeek() {
  if(state.week <= 5) return ' ‚Ä¢ Tempo 3-1-2 (Bloc 1)';
  else if(state.week <= 11) return ' ‚Ä¢ Rest-Pause (Bloc 2)';
  else if(state.week <= 17) return ' ‚Ä¢ Drop-sets + Myo-reps (Bloc 3)';
  else return ' ‚Ä¢ Clusters + Partials (Bloc 4)';
}

// === RESTE DU CODE EXISTANT (inchang√©) ===
// [Le reste du code JavaScript reste identique...]

// Initialisation
state = loadState();
renderAll();

// √âv√©nements
document.getElementById('nextWeek').addEventListener('click', ()=>{
  state.week = Math.min(26, state.week+1); 
  saveState(); 
  renderAll(); 
  showQuick(`Semaine ${state.week}`);
});
document.getElementById('prevWeek').addEventListener('click', ()=>{
  state.week = Math.max(1, state.week-1); 
  saveState(); 
  renderAll(); 
  showQuick(`Semaine ${state.week}`);
});

document.getElementById('openStats').addEventListener('click', openStatsModal);
document.getElementById('openVolume').addEventListener('click', openVolumeModal);
document.getElementById('openMuscle').addEventListener('click', openMuscleModal);

window.openSession = openSession;
window.savePerf = savePerf;
window.openModifyWeight = openModifyWeight;
window.closeModal = closeModal;

setInterval(()=> saveState(), 20000);

// === HEATMAP PREMIUM ===
// [Le code de la heatmap reste inchang√©...]
</script>
</body>
</html>
